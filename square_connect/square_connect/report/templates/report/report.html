{% extends "app/layout.html" %}

{% block content %}

<script>
    $( document ).ready(function() {
        $.noConflict();

        $( "#start_datepicker" ).datepicker().val("{{ today }}");
        $( "#end_datepicker" ).datepicker().val("{{ today }}");

        // AJAX for requesting report
        function submit_form() {
            $.ajax({
                url : "{% url 'request_custom_report' %}",
                type : "POST", // http method
                data : { service : $('#service_select').val(), discount : $('#discount_select').val(), start_date : $('#start_datepicker').val(), end_date : $('#end_datepicker').val() }, // data sent with the post request

                // handle a successful response
                success : function(json) {
                    var parsed_data = json;
                    console.log(json);
                    if (typeof parsed_data.reports == 'undefined') {
                        $("#reports-table tbody").html("<center><b>No results found!</b></center>");
                        return;
                    }

                    if (parsed_data.reports.length > 0) {
                        // Title row
                        $("#reports-table tbody").html("\
                            <tr>\
                                <th>Service</th>\
                                <th>Item</th>\
                                <th>Variant</th>\
                                <th>Discount Type</th>\
                                <th>Discount</th>\
                                <th>Quantity</th>\
                                <th>Price</th>\
                                <th>Transaction ID</th>\
                                <th>Time</th>\
                            </tr>\
                        ");
                        
                        // Dynamically populates discount drop down
                        var discount_options = [];
                        var select = document.getElementById("discount_select");
                        // Resets discount options so that they don't add up every time someone fetches a report
                        select.options.length = 1;

                        for (i = 0; i < parsed_data.reports.length; i++) {
                            for (j = 0; j < parsed_data.reports[i]['size']; j++) {
                                // Keeps track of discounts in this particular report
                                var discount = parsed_data.reports[i]['items'][j]['discount']
                                if (discount_options.indexOf(discount) == -1) {
                                    discount_options.push(discount);
                                    select.options[select.options.length] = new Option(discount, discount);
                                }
                                
                                datetime = new Date(parsed_data.reports[i]['items'][j]['transaction_time']);
                                $("#reports-table tbody").append("\
                                    <tr>\
                                        <td>" + parsed_data.reports[i]['items'][j]['service'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['name'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['variant'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['discount'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['discountcost'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['quantity'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['price'] + "</td>\
                                        <td><a href=\"https://squareup.com/receipt/preview/" + parsed_data.reports[i]['items'][j]['transaction_id'] + "\" target=\"_blank\">View receipt</a></td>\
                                        <td>" + datetime.toLocaleString() + "</td>\
                                    </tr>\
                                ");
                            }
                            $("#reports-table tbody").append("\
                                <tr>\
                                    <td/>\
                                    <td/>\
                                    <td/>\
                                    <td align='right'><b>Total:</b></right></td>\
                                    <td>" + parsed_data.reports[i]['discount_total'] + "</td>\
                                    <td align='right'><b>Total:</b></right></td>\
                                    <td>" + parsed_data.reports[i]['total'] + "</td>\
                                    <td/>\
                                    <td/>\
                                </tr>\
                            ");
                        }
                        
                        

                        // Sum Total row
                        $("#reports-table tbody").append("\
                            <tr>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                            </tr>\
                            <tr>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td align='right'><b>Discount Sum Total:</b></td>\
                                <td>" + parsed_data.discount_sum_total + "</td>\
                                <td align='right'><b>Price Sum Total:</b></td>\
                                <td>" + parsed_data.sum_total + "</td>\
                                <td/>\
                                <td/>\
                            </tr>\
                        ");
                    }
                },

                // handle an unsuccessful response
                error : function(xhr, errmsg, err) {
                    /*$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console*/
                    console.log("Something got fucked up.");
                }
            });
        };

        $('#report-form-button').click(function() {
            submit_form();
        });
        window.onload = submit_form();
    });
</script>


<div class="jumbotron">
    <h1>Reports</h1>
    <table class="table">
        <tr>
            <th>
                <p>Service:
                <select id="service_select" name="service">
                    <option selected="selected" value="all">All Services</option>
                    <option value="mug">MUG</option>
                    <option value="vittles">Vital Vittles</option>
                    <option value="snaxa">Hoya Snaxa</option>
                    <option value="ug">Uncommon Grounds</option>
                    <option value="midnight">Midnight Mug</option>
                    <option value="hilltoss">Hilltoss</option>
                </select> </p>
            </th>
            <th>
                <p>Discount:
                <select id="discount_select" name="discount">
                    <option selected="selected" value="all">All Discounts</option>
                </select> </p>
            </th>
            <th>
                <p>Start Date: <input name="start_date" type="text" id="start_datepicker"></p>
            </th>
            <th>
                <p>End Date: <input name="end_date" type="text" id="end_datepicker"></p>
            </th>
            <th>
                <br>
                <button id="report-form-button" type="submit" class="btn btn-default">Retrieve report</button>
            </th>
        </tr>
    </table>
    <h3>Search Results:</h3>
    <div class="table-responsive">
        <table id="reports-table" class="table">
            <tbody></tbody>
        </table>
    </div>
    <!--form role="form" class="form-horizontal" method="post">
        {% csrf_token %}
        <div class="form-group">
            <center>
                Send Spoilage Report to Accounting<br />
                <button type="submit" class="btn btn-default">Send</button>
            </center>
        </div>
        <input type="hidden" name="send" value="yes" />
    </form-->
</div>

{% endblock %}
