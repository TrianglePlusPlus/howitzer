{% extends "app/layout.html" %}

{% block content %}

<script>
    $( document ).ready(function() {
        $.noConflict();

        var populate = true;
        var current_service = "initial page load";
        var current_discount = $('#discount_select').val();
        var url_accessed = false;
        var second_loop = false; // The page technically loads twice so this will keep track of that
        
        // Dynamically populates discount drop down
        // Currently does not handle edge case of User selects a specific discount looking at all services. Then narrows down by service. The discount drop-down has no knowledge of the narrowed down service's list of discounts. Not sure how to get around that
        
        var discount_options = [];
        var select = document.getElementById("discount_select");
        
        if ("{{ today }}" == ""){
            $("#start_datepicker").datepicker().val("{{ start_date }}");
            $("#end_datepicker").datepicker().val("{{ end_date }}");
            $("#service_select").val("{{ service }}");
            current_discount = "{{ discount }}";
            discount_options.push(current_discount);
            select.options[select.options.length] = new Option(current_discount, current_discount);
            $("#discount_select").val(current_discount);
            url_accessed = true;
            submit_form()
        }
        else {
            $( "#start_datepicker" ).datepicker().val("{{ today }}");
            $( "#end_datepicker" ).datepicker().val("{{ today }}");
        }

        // AJAX for requesting report
        function submit_form() {
            $.ajax({
                url : "{% url 'request_custom_report' %}",
                type : "POST", // http method
                data : { service : $('#service_select').val(), discount : $('#discount_select').val(), start_date : $('#start_datepicker').val(), end_date : $('#end_datepicker').val() }, // data sent with the post request               

                // handle a successful response
                success : function(json) {
                    var parsed_data = json;
                    var start_date_input = $('#start_datepicker').val().split('/');
                    var end_date_input = $('#end_datepicker').val().split('/');
                    var start_date = new Date(start_date_input[2], start_date_input[0] - 1, start_date_input[1]); // -1 necessary as js months are 0-based
                    var end_date = new Date(end_date_input[2], end_date_input[0] - 1, end_date_input[1]); // see above comment
                    var start_date_str = start_date.getFullYear() + '/' + (start_date.getMonth() + 1).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '/' + start_date.getDate().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});
                    var end_date_str = end_date.getFullYear() + '/' + (end_date.getMonth() + 1).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '/' + end_date.getDate().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false});

                    if (url_accessed == true) {
                        history.replaceState(null, null, '/report/' + $('#service_select').val() + '/' + current_discount + '/' + start_date_str + '/' + end_date_str);
                        if (second_loop == true){
                            url_accessed = false;
                        }
                        else {
                            second_loop = true;
                        }
                    }
                    else {
                        history.replaceState(null, null, '/report/' + $('#service_select').val() + '/' + $('#discount_select').val() + '/' + start_date_str + '/' + end_date_str);
                    }
                    console.log(json);
                    if (typeof parsed_data.reports == 'undefined') {
                        $("#reports-table tbody").html("<center><b>No results found!</b></center>");
                        return;
                    }

                    if (parsed_data.reports.length > 0) {
                        // Title row
                        $("#reports-table tbody").html("\
                            <tr>\
                                <th>Service</th>\
                                <th>Item</th>\
                                <th>Variant</th>\
                                <th>Discount Type</th>\
                                <th>Discount</th>\
                                <th>Quantity</th>\
                                <th>Price</th>\
                                <th>Transaction ID</th>\
                                <th>Time</th>\
                            </tr>\
                        ");
                        
                        
                        // Logic handling drop down population while maintaining an individual service's discounts
                        // I.E. Don't repopulate if we're narrowing down discounts. Only repopulate if the service changes
                        
                        // Populate the first time
                        if (current_service == "initial page load"){
                            populate = true;
                            current_service = $('#service_select').val();
                        }
                        // If we haven't switched services don't repopulate, unless we're looking at all discounts (This is so they can be repopulated if they get narrowed down due to direct URL accessing)
                        else if (current_service == $('#service_select').val()){
                            if ($('#discount_select').val() == 'all'){
                                populate = true;
                            }
                            else{
                                populate = false;
                            }
                        }
                        // If the current service is different from the last service repopulate
                        else{
                            populate = true;
                            current_service = $('#service_select').val();
                        }
                        
                        if (populate == true){
                            if (url_accessed == false){
                                select.options.length = 1;
                                discount_options = [];
                            }
                            else{
                                select.options.length = 2;
                                discount_options = [];
                            }
                        }

                        for (i = 0; i < parsed_data.reports.length; i++) {
                            for (j = 0; j < parsed_data.reports[i]['size']; j++) {
                                // Keeps track of discounts in this particular report
                                var discount = parsed_data.reports[i]['items'][j]['discount']
                                if (populate == true) {
                                    // If discount is not in discount options, add it 
                                    if (discount_options.indexOf(discount) == -1) {
                                        discount_options.push(discount);
                                        select.options[select.options.length] = new Option(discount, discount);
                                    }
                                }

                                datetime = new Date(parsed_data.reports[i]['items'][j]['transaction_time']);
                                $("#reports-table tbody").append("\
                                    <tr>\
                                        <td>" + parsed_data.reports[i]['items'][j]['service'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['name'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['variant'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['discount'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['discountcost'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['quantity'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['price'] + "</td>\
                                        <td><a href=\"https://squareup.com/receipt/preview/" + parsed_data.reports[i]['items'][j]['transaction_id'] + "\" target=\"_blank\">View receipt</a></td>\
                                        <td>" + datetime.toLocaleString() + "</td>\
                                    </tr>\
                                ");
                            }
                            $("#reports-table tbody").append("\
                                <tr>\
                                    <td/>\
                                    <td/>\
                                    <td/>\
                                    <td align='right'><b>Total:</b></right></td>\
                                    <td>" + parsed_data.reports[i]['discount_total'] + "</td>\
                                    <td align='right'><b>Total:</b></right></td>\
                                    <td>" + parsed_data.reports[i]['total'] + "</td>\
                                    <td/>\
                                    <td/>\
                                </tr>\
                            ");
                        }
                        
                        // Finalizes the list of discount options
                        populate = false;

                        // Sum Total row
                        $("#reports-table tbody").append("\
                            <tr>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                            </tr>\
                            <tr>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td align='right'><b>Discount Sum Total:</b></td>\
                                <td>" + parsed_data.discount_sum_total + "</td>\
                                <td align='right'><b>Price Sum Total:</b></td>\
                                <td>" + parsed_data.sum_total + "</td>\
                                <td/>\
                                <td/>\
                            </tr>\
                        ");
                    }
                },

                // handle an unsuccessful response
                error : function(xhr, errmsg, err) {
                    /*$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console*/
                    console.log("Something got fucked up.");
                }
            });
        };

        $('#report-form-button').click(function() {
            submit_form();
        });
        window.onload = submit_form();
    });
</script>


<div class="jumbotron">
    <h1>Reports</h1>
    <table class="table">
        <tr>
            <th>
                <p>Service:
                <select id="service_select" name="service">
                    <option selected="selected" value="all">All Services</option>
                    <option value="mug">MUG</option>
                    <option value="vittles">Vital Vittles</option>
                    <option value="snaxa">Hoya Snaxa</option>
                    <option value="ug">Uncommon Grounds</option>
                    <option value="midnight">Midnight Mug</option>
                    <option value="hilltoss">Hilltoss</option>
                </select> </p>
            </th>
            <th>
                <p>Discount:
                <select id="discount_select" name="discount">
                    <option selected="selected" value="all">All Discounts</option>
                </select> </p>
            </th>
            <th>
                <p>Start Date: <input name="start_date" type="text" id="start_datepicker"></p>
            </th>
            <th>
                <p>End Date: <input name="end_date" type="text" id="end_datepicker"></p>
            </th>
            <th>
                <br>
                <button id="report-form-button" type="submit" class="btn btn-default">Retrieve report</button>
            </th>
        </tr>
    </table>
    <h3>Search Results:</h3>
    <div class="table-responsive">
        <table id="reports-table" class="table">
            <tbody></tbody>
        </table>
    </div>
    <!--form role="form" class="form-horizontal" method="post">
        {% csrf_token %}
        <div class="form-group">
            <center>
                Send Spoilage Report to Accounting<br />
                <button type="submit" class="btn btn-default">Send</button>
            </center>
        </div>
        <input type="hidden" name="send" value="yes" />
    </form-->
</div>

{% endblock %}
