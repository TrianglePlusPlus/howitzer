{% extends "app/layout.html" %}

{% block content %}

<div class="jumbotron">
    <h1>Mailer</h1>
    <form method="post">
        {% csrf_token %}
        <table class="table">
            <tr>
                <th>
                    <p>First Name: {{ person_form.first_name }}</p>
                </th>
                <th>
                    <p>Last Name: {{ person_form.last_name }}</p>
                </th>
                <th>
                    <p>Email: {{ person_form.email }}</p>
                </th>
                <th>
                    <button type="submit" class="btn btn-default">Add person</button>
                </th>
            </tr>
        </table>
    </form>
    <h2>People</h2>
    <ul>
    {% for person in persons %}
        <h3><button type="button" class="btn btn-default delete-person-submit" data-person="{{ person.id }}">X</button> {{ person }}: {{ person.email }}</h3>
        <ul>
        {% for subscription in person.subscriptions.all %}
            <li><button type="button" class="btn btn-default delete-subscription-submit" data-person="{{ person.id }}" data-subscription="{{ subscription.id }}">X</button> {{ subscription.service_name }}{% if subscription.discount != 'all' %}, filtered for the {{ subscription.discount }} discount{% endif %}</li>
        {% endfor %}
            <li>
                <form id="new-subscription-form" method="post">
                    {% csrf_token %}
                    <p>Service: {{ subscription_form.service }}</p>
                    <p>Discount: {{ subscription_form.discount }}</p>
                    <input type="hidden" name="person" value="{{ person.id }}">
                    <p><button type="submit" class="btn btn-default">New Subscription</button></p>
                </form>
            </li>
        </ul>
    {% endfor %}
    </ul>
    <form id="delete-person-form" method="post">
        {% csrf_token %}
        <input type="hidden" id="delete-person-input" name="person">
    </form>
    <form id="delete-subscription-form" method="post">
        {% csrf_token %}
        <input type="hidden" id="delete-subscription-person-input" name="person">
        <input type="hidden" id="delete-subscription-input" name="subscription">
    </form>
</div>

<script>
$(document).ready(function() {
    $(".delete-person-submit").click(function() {
        $("#delete-person-input").val(event.target.dataset.person);
        $("#delete-person-form").submit();
    });
    $(".delete-subscription-submit").click(function() {
        $("#delete-subscription-person-input").val(event.target.dataset.person);
        $("#delete-subscription-input").val(event.target.dataset.subscription);
        $("#delete-subscription-form").submit();
    });
});
</script>

{% endblock %}
