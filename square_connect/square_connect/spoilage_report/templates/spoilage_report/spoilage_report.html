{% extends "app/layout.html" %}

{% block content %}


<script>
    $( document ).ready(function() {
        $.noConflict();

        // Creates sticky dates in form
    	if( "{{ first_report }}" == "None" || "{{ first_report }}" == "[]" ){
    		$( "#start_datepicker" ).datepicker().val("{{ today }}");
            $( "#end_datepicker" ).datepicker().val("{{ today }}");
    	}	
    	else {
            $( "#start_datepicker" ).datepicker().val("{{ first_report.date|date:"m/d/Y" }}");
    		$( "#end_datepicker" ).datepicker().val("{{ first_report.date|date:"m/d/Y" }}");
    	}
    	// Creates sticky dropdown in form
    	if( "{{ first_report }}" != "[]" && "{{ first_report }}" != "None" ) {
    		$( "#service_select" ).val("{{ first_report.service.name }}");
    	}

        // AJAX for requesting report
        function submit_form() {
            $.ajax({
                url : "{% url 'request_report' %}",
                type : "POST", // http method
                data : { service : $('#service_select').val(), start_date : $('#start_datepicker').val(), end_date : $('#end_datepicker').val() }, // data sent with the post request

                // handle a successful response
                success : function(json) {
                    console.log(json); // log the returned json to the console
                },

                // handle an unsuccessful response
                error : function(xhr, errmsg, err) {
                    /*$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console*/
                    console.log("Something got fucked up.");
                }
            });
        };

        $('#report-form').on('submit', function(event) {
            event.preventDefault();
            submit_form();
        });
    });
</script>

<div class="jumbotron">
    <div id="results"/>
    <h1>Spoilage Reports</h1>
    <form id="report-form" role="form" class="form-horizontal" method="post">
        {% csrf_token %}
        <table class="table">
            <tr>
                <th>
                    <select id="service_select" name="service">
                        <option selected="selected">-- Select Service --</option>
                        <option value="mug">MUG</option>
                        <option value="vittles">Vital Vittles</option>
                        <option value="snaxa">Hoya Snaxa</option>
                        <option value="ug">Uncommon Grounds</option>
                        <option value="midnight">Midnight Mug</option>
                        <option value="hilltoss">Hilltoss</option>
                    </select>
                </th>
                <th>
                    <p>Start Date: <input name="start_date" type="text" id="start_datepicker"></p>
                </th>
                <th>
                    <p>End Date: <input name="end_date" type="text" id="end_datepicker"></p>
                </th>
                <th>
                    <button type="submit" class="btn btn-default">Retrieve report</button>
                </th>
            </tr>
        </table>
    </form>
    <h3>Search Results:</h3>
    <div class="table-responsive">
        <table class="table">
            {% if reports.count > 0 %}
                <tr>
                    <th>Item</th>
                    <th>Variant</th>
                    <th>SKU</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Transaction ID</th>
                    <th>Time</th>
                </tr>
            {% else %}
                <center><b>No results found!</b></center>
            {% endif %}
            {% for report in reports %}
                {% for item in report.get_associated_items %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.variant }}</td>
                        <td>{{ item.sku }}</td>
                        <td>{{ item.price }}</td>
                        <td>{{ item.quantity }}</td>
                        <td><a href="https://squareup.com/receipt/preview/{{ item.transaction_id }}" target="_blank">View receipt</a></td>
                        <td>{{ item.transaction_time }}</td>
                    </tr>
                {% endfor %}
                {% if report.get_size > 0 %}
                <tr>
                    <td/>
                    <td/>
                    <td><b>Total:</b></td>
                    <td>{{ report.get_total }}</td>
                    <td/>
                    <td/>
                    <td/>
                </tr>
                {% endif %}
            {% endfor %}
            {% if reports.count > 0 %}
                <tr>
                    <td/>
                    <td/>
                    <td/>
                    <td/>
                    <td/>
                    <td/>
                    <td/>
                </tr>
                <tr>
                    <td/>
                    <td/>
                    <td><b>Sum Total:</b></td>
                    <td>{{ sum_total }}</td>
                    <td/>
                    <td/>
                    <td/>
                </tr>
            {% endif %}
        </table>
    </div>
    <!--
    <form role="form" class="form-horizontal" method="post">
        {% csrf_token %}
        <div class="form-group">
            <center>
                Send Spoilage Report to Accounting<br />
                <button type="submit" class="btn btn-default">Send</button>
            </center>
        </div>
        <input type="hidden" name="send" value="yes" />
    </form-->
</div>

{% endblock %}
