{% extends "app/layout.html" %}

{% block content %}
{% load staticfiles%}
<script src="{% static 'app/scripts/jquery.cookie.js' %}"></script>

<script>
    $( document ).ready(function() {
        $.noConflict();

        var csrftoken = $.cookie('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        if ("{{ today }}" == "") {
            $("#start_datepicker").datepicker().val("{{ start_date }}");
            $("#end_datepicker").datepicker().val("{{ end_date }}");
            $("#service_select").val("{{ service }}");
            submit_form();
        }
        else {
            $("#start_datepicker").datepicker().val("{{ today }}");
            $("#end_datepicker").datepicker().val("{{ today }}");
        }

        // AJAX for requesting report
        function submit_form() {
            $.ajax({
                url : "{% url 'request_report' %}",
                type : "POST", // http method
                data : { service : $('#service_select').val(), start_date : $('#start_datepicker').val(), end_date : $('#end_datepicker').val() }, // data sent with the post request

                // handle a successful response
                success : function(json) {
                    var parsed_data = json;

                    var start_date_input = $('#start_datepicker').val().split('/');
                    var end_date_input = $('#end_datepicker').val().split('/');
                    var start_date = new Date(start_date_input[2], start_date_input[0] - 1, start_date_input[1]); // -1 necessary as js months are 0-based
                    var end_date = new Date(end_date_input[2], end_date_input[0] - 1, end_date_input[1]); // see above comment
                    var start_date_str = (start_date.getMonth() + 1).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '/' + start_date.getDate().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '/' + start_date.getFullYear();
                    var end_date_str =  (end_date.getMonth() + 1).toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '/' + end_date.getDate().toLocaleString('en-US', {minimumIntegerDigits: 2, useGrouping:false}) + '/' + end_date.getFullYear();

                    history.replaceState(null, null, '/spoilage_report?service=' + $('#service_select').val() + '&start_date=' + start_date_str + '&end_date=' + end_date_str);

                    if (typeof parsed_data.reports == 'undefined') {
                        $("#reports-table tbody").html("<b>No results found!</b>");
                        return;
                    }

                    if (parsed_data.reports.length > 0) {
                        // Title row
                        $("#reports-table tbody").html("\
                            <tr>\
                                <th>Item</th>\
                                <th>Variant</th>\
                                <th>Price</th>\
                                <th>Quantity</th>\
                                <th>Transaction ID</th>\
                                <th>Time</th>\
                            </tr>\
                        ");

                        for (i = 0; i < parsed_data.reports.length; i++) {
                            for (j = 0; j < parsed_data.reports[i]['size']; j++) {
                                datetime = new Date(parsed_data.reports[i]['items'][j]['transaction_time']);
                                $("#reports-table tbody").append("\
                                    <tr>\
                                        <td>" + parsed_data.reports[i]['items'][j]['name'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['variant'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['price'] + "</td>\
                                        <td>" + parsed_data.reports[i]['items'][j]['quantity'] + "</td>\
                                        <td><a href=\"https://squareup.com/receipt/preview/" + parsed_data.reports[i]['items'][j]['transaction_id'] + "\" target=\"_blank\">View receipt</a></td>\
                                        <td>" + datetime.toLocaleString() + "</td>\
                                    </tr>\
                                ");
                            }
                            $("#reports-table tbody").append("\
                                <tr>\
                                    <td/>\
                                    <td align='right'><b>Total:</b></right></td>\
                                    <td>" + parsed_data.reports[i]['total'] + "</td>\
                                    <td/>\
                                    <td/>\
                                    <td/>\
                                </tr>\
                            ");
                        }

                        // Sum Total row
                        $("#reports-table tbody").append("\
                            <tr>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                                <td/>\
                            </tr>\
                            <tr>\
                                <td/>\
                                <td align='right'><b>Sum Total:</b></td>\
                                <td>" + parsed_data.sum_total + "</td>\
                                <td/>\
                                <td/>\
                                <td/>\
                            </tr>\
                        ");
                    }
                },

                // handle an unsuccessful response
                error : function(xhr, errmsg, err) {
                    /*$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                        " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console*/
                    console.log("Something got fucked up.");
                }
            });
        };

        $('#report-form-button').click(function() {
            submit_form();
        });

        $('#export-csv-button').click(function() {
            var form = $('<form/>', {
                action: "{% url 'export_csv' %}",
                method: "post"
            });
            form.append("{% csrf_token %}");
            form.append($('<input/>', {
                    type: 'hidden',
                    name: 'service',
                    value: $('#service_select').val()
            }));
            form.append($('<input/>', {
                    type: 'hidden',
                    name: 'start_date',
                    value: $('#start_datepicker').val()
            }));
            form.append($('<input/>', {
                    type: 'hidden',
                    name: 'end_date',
                    value: $('#end_datepicker').val()
            }));
            form.submit();
        });
    });
</script>
<div class="jumbotron">
    <h1>Spoilage Reports</h1>
    <div class="form-group">
        <label>Select Service</label>
    	<select id="service_select" name="service" class="form-control">
            <option selected="selected">-- Select Service --</option>
            <option value="mug">MUG</option>
            <option value="vittles">Vital Vittles</option>
            <option value="snaxa">Hoya Snaxa</option>
            <option value="ug">Uncommon Grounds</option>
            <option value="midnight">Midnight Mug</option>
            <option value="hilltoss">Hilltoss</option>
       </select>
    </div>
    <div class="form-group">
        <label>Start Date</label>
        <input name="start_date" type="text" id="start_datepicker" class="form-control"></input>
    </div>
    <div class="form-group">
        <label>End Date</label>
        <input name="end_date" type="text" id="end_datepicker" class="form-control"></input>
    </div>
    <button id="report-form-button" type="submit" class="btn btn-info">Retrieve report</button>
    <h2>Search Results</h2>
    <div class="table-responsive">
        <table id="reports-table" class="table">
            <tbody></tbody>
        </table>
        <form action="" method="post">
            <input type="hidden" name="service" value="">
            <input type="hidden" name="start_date" value="">
            <input type="hidden" name="end_date" value="">
        </form>
    </div>
</div>

{% endblock %}
